[{"path":"index.html","id":"preface","chapter":"1 Preface","heading":"1 Preface","text":"quick tutorial Dockerfiles R, using practical examples.","code":""},{"path":"intro.html","id":"intro","chapter":"2 Introduction","heading":"2 Introduction","text":"","code":""},{"path":"copying-files-and-folders.html","id":"copying-files-and-folders","chapter":"3 Copying files and folders","heading":"3 Copying files and folders","text":"","code":""},{"path":"copying-files-and-folders.html","id":"copy-a-package-tar.gz-file","chapter":"3 Copying files and folders","heading":"3.1 Copy a package tar.gz file","text":"important end destination folder image slash. Like : /home/rstudio/pkg/.","code":"# install a package from source\nCOPY pkg/sbrl_1.2.tar.gz /home/rstudio/pkg/\nRUN R CMD INSTALL /home/rstudio/pkg/sbrl_1.2.tar.gz"},{"path":"copying-files-and-folders.html","id":"copy-the-current-folder","chapter":"3 Copying files and folders","heading":"3.2 Copy the current folder","text":"","code":"## Copy the current directory to /analysis\nCOPY . /analysis"},{"path":"copying-files-and-folders.html","id":"copying-folders","chapter":"3 Copying files and folders","heading":"3.3 Copying folders","text":"Copy two folders image:","code":"## Copy your working files over\n## The $USER defaults to `rstudio` but you can change this at runtime\nCOPY ./Analysis /home/$USER/Analysis\nCOPY ./Data /home/$USER/Data"},{"path":"copying-files-and-folders.html","id":"copy-an-r-script-to-an-image","chapter":"3 Copying files and folders","heading":"3.4 Copy an R script to an image","text":"","code":"## Copy requirements.R to container directory /tmp\nCOPY ./DockerConfig/requirements.R /tmp/requirements.R \n## install required libs on container\nRUN Rscript /tmp/requirements.R"},{"path":"copying-files-and-folders.html","id":"copy-a-folder-from-a-stage-image","chapter":"3 Copying files and folders","heading":"3.5 Copy a folder from a stage image","text":"","code":"# copy conky that was built from source\nCOPY --from=builder /opt/conky /opt/conky"},{"path":"copying-files-and-folders.html","id":"copy-folder-using-the-stage-number-instead-of-the-name","chapter":"3 Copying files and folders","heading":"3.6 Copy folder using the stage number instead of the name","text":"","code":"# source: https://github.com/bcicen/ctop\n\nFROM quay.io/vektorcloud/go:1.12\n\nRUN apk add --no-cache make\n\nWORKDIR /app\nCOPY go.mod .\nRUN go mod download\n\nCOPY . .\nRUN make build && \\\n    mkdir -p /go/bin && \\\n    mv -v ctop /go/bin/\n\nFROM scratch\nENV TERM=linux\n\nCOPY --from=0 /go/bin/ctop /ctop\nENTRYPOINT [\"/ctop\"]"},{"path":"copying-files-and-folders.html","id":"using-add","chapter":"3 Copying files and folders","heading":"3.7 Using ADD","text":"ADD another way copy files recommended.\nExample:copy folder tools host root folder container.","code":"FROM debian:testing\nADD tools/rootfs.tar.xz /"},{"path":"using-arguments-and-variables.html","id":"using-arguments-and-variables","chapter":"4 Using arguments and variables","heading":"4 Using arguments and variables","text":"","code":""},{"path":"using-arguments-and-variables.html","id":"passing-an-argument","chapter":"4 Using arguments and variables","heading":"4.1 Passing an argument","text":"","code":""},{"path":"using-arguments-and-variables.html","id":"r_version","chapter":"4 Using arguments and variables","heading":"4.1.1 R_VERSION","text":"want pass version R install specify adding argument, let’s say R_VERSION, convert environment variable name extracts values provided user argument, default value provided colon :.Example: argument R_VERSION supplied user. name used environment variable pick version entered user, default value -3.5.3 nothing provided argument.variable can later used Dockerfile. example downloading installing R version source code.","code":"ARG R_VERSION\nENV R_VERSION=${R_VERSION:-3.5.3}RUN curl -O https://cran.r-project.org/src/base/R-3/R-${R_VERSION}.tar.gz"},{"path":"using-arguments-and-variables.html","id":"build_date","chapter":"4 Using arguments and variables","heading":"4.1.2 BUILD_DATE","text":"Example: Similarly, build date packages can entered argument BUILD_DATE. , , empty, default value 2019-0426 assigned environment variable name.typical use build date installing packages MRAN certain point time.Example: set MRAN download packages shiny markdown certain data, use:","code":"ARG BUILD_DATE\nENV BUILD_DATE ${BUILD_DATE:-2019-04-26}RUN MRAN=https://mran.microsoft.com/snapshot/${BUILD_DATE} \\\n    R -e \"install.packages(c('shiny', 'rmarkdown'), repos='$MRAN')\""},{"path":"using-arguments-and-variables.html","id":"rstudio_version","chapter":"4 Using arguments and variables","heading":"4.1.3 RSTUDIO_VERSION","text":"Example: following script build URL download link RStudio.deb file. value environment variable RSTUDIO_VERSION empty, check done [ -z \"$RSTUDIO_VERSION\" ], latest version installed. RStudio version provided, URL take value environment variable inserting string ${RSTUDIO_VERSION}.","code":"ARG RSTUDIO_VERSION\nENV RSTUDIO_VERSION=${RSTUDIO_VERSION:-1.2.5019}\n\nRUN if [ -z \"$RSTUDIO_VERSION\" ]; then RSTUDIO_URL=\"https://www.rstudio.org/download/latest/stable/server/debian9_64/rstudio-server-latest-amd64.deb\"; else RSTUDIO_URL=\"http://download2.rstudio.org/server/debian9/x86_64/rstudio-server-${RSTUDIO_VERSION}-amd64.deb\"; fi \\\n&& wget -q $RSTUDIO_URL \\\n&& dpkg -i rstudio-server-*-amd64.deb"},{"path":"using-rscript-and-littler.html","id":"using-rscript-and-littler","chapter":"5 Using Rscript and littler","heading":"5 Using Rscript and littler","text":"","code":""},{"path":"using-rscript-and-littler.html","id":"install-packages-with-littler","chapter":"5 Using Rscript and littler","heading":"5.1 Install packages with littler","text":"equivalent Rscript:","code":"RUN install2.r --error \\\n    --repo https://cran.rstudio.com/  \\\n    haven \\\n    tibble \\\n    xml2 RUN Rscript -e \"install.packages(c(\\\n  'haven', \\\n  'tibble', \\\n  'xml2', \\\n  ), repos='https://cran.rstudio.com/')\""},{"path":"using-rscript-and-littler.html","id":"install-dependencies-with-install2.r","chapter":"5 Using Rscript and littler","heading":"5.2 Install dependencies with install2.r","text":"Example: want install Java first R packages depend Java","code":"RUN install2.r --error \\\n    --deps TRUE \\\n    pks \\\n    pander \\\n    forecast# -------------------------  SECTION Install Java -----------------\n# Install Java\n# extracted from  rocker-versioned/verse/3.5.3.Dockerfile \nRUN apt-get update \\\n  && apt-get install -y --no-install-recommends \\\n    ## for rJava\n    default-jdk \\\n    ## used to build rJava and other packages\n    libbz2-dev \\\n    libicu-dev \\\n    liblzma-dev \\\n    && install2.r --error --deps TRUE \\\n    bookdown rticles rmdshower rJava RWeka"},{"path":"building-a-book-as-a-package.html","id":"building-a-book-as-a-package","chapter":"6 Building a book as a package","heading":"6 Building a book as a package","text":"","code":""},{"path":"building-a-book-as-a-package.html","id":"introduction","chapter":"6 Building a book as a package","heading":"6.1 Introduction","text":"advantage building book package packages mentioned Imports DESCRIPTION file get installed book building operation commences. ideal feature want automate book building Docker Travis.two key parts achieve :Write dummy DESCRIPTION file dependencies spelled outCopy DESCRIPTION file imageInstall packages Imports file DESCRIPTION","code":""},{"path":"building-a-book-as-a-package.html","id":"building-the-edav-book","chapter":"6 Building a book as a package","heading":"6.2 Building the edav book","text":"","code":""},{"path":"building-a-book-as-a-package.html","id":"steps","chapter":"6 Building a book as a package","heading":"6.2.1 Steps","text":"first step writing DESCRIPTION file. look like :, Dockerfile copy DESCRIPTION home folder:copy dummy DESCRIPTION file image., devtools::install function proceeds install packages image:","code":"Package: edav.pkg\nType: Package\nTitle: What the package does (short line)\nVersion: 0.1\nDate: 2019-08-27\nAuthor: msfz751\nMaintainer: Who to complain to <yourfault@somewhere.net>\nDescription: More about what it does (maybe more than one line)\nLicense: What license is it under?\nImports: logging,\n  Matrix,\n  dplyr,\n  ggplot2,\n  gridExtra,\n  MASS,\n  tidyr,\n  tidyverse,\n  scales,\n  knitr,\n  mi,\n  AER,\n  leaflet,\n  htmltools,\n  leaflet.extras,\n  viridis,\n  fpp,\n  imputeTS,\n  GGally,\n  datasets,\n  lubridate,\n  likert,\n  GDAdata,\n  lattice,\n  Sleuth3,\n  ggsci,\n  ggthemes,\n  vcd,\n  grid,\n  vcdExtra,\n  ggmosaic,\n  pgmm,\n  ggridges,\n  cluster,\n  tidyquant,\n  choroplethr,\n  jsonlite,\n  RCurl,\n  odbc,\n  DBI,\n  visNetwork,\n  ggplot2movies,\n  choroplethrMaps,\n  forecast,\n  TSPCOPY DESCRIPTION /home/rstudio/edav/# install packages using DESCRIPTION file\nRUN R -e \"devtools::install(\\\n    '/home/rstudio/edav', \\\n    keep_source=TRUE, \\\n    args='--install-tests', \\\n    dependencies=TRUE)\""},{"path":"building-a-book-as-a-package.html","id":"dockerfile","chapter":"6 Building a book as a package","heading":"6.2.2 Dockerfile","text":"","code":"# Dockerfile for the book \"edav*\n# BUILD_DATE for R-3.6.3 is 2020-04-24\n# FROM rocker/verse:3.6.3\nFROM f0nzie/gitbook:3.6.3\n\nRUN . /etc/environment \\\n    && mkdir /home/rstudio/edav\n\nCOPY DESCRIPTION /home/rstudio/edav/\n\n# install packages using DESCRIPTION file\nRUN R -e \"devtools::install(\\\n    '/home/rstudio/edav', \\\n    keep_source=TRUE, \\\n    args='--install-tests', \\\n    dependencies=TRUE)\"\n\n# copy package sources\nCOPY pkg/extracat /home/rstudio/pkg/extracat\nCOPY pkg/ggthemr /home/rstudio/pkg/ggthemr\nCOPY pkg/statebins /home/rstudio/pkg/statebins\n\n# install from package sources\nRUN Rscript -e \"install.packages(c(\\\n  '/home/rstudio/pkg/extracat', \\\n  '/home/rstudio/pkg/ggthemr', \\\n  '/home/rstudio/pkg/statebins' \\\n  ), repos = NULL, type='source')\"\n\n\nCOPY book /home/rstudio/edav/book/\nWORKDIR /home/rstudio/edav/book\nRUN Rscript -e 'bookdown::render_book(\"index.Rmd\", \"bookdown::gitbook\")'\n\n# change owner:group to current user\nRUN chown -R 1001:1001 public\nCOPY copy_gitbook.sh /home/rstudio/edav\n\n\n# execute script `copy_gitbook.sh` from the host:\n#   docker run --rm -v $PWD/share:/home/rstudio/share edav ../copy_gitbook.sh\n# which will copy the book output folder `public` to the host `share` folder"},{"path":"install-packages-from-source.html","id":"install-packages-from-source","chapter":"7 Install packages from source","heading":"7 Install packages from source","text":"occasionally need copy package sources available anymore, freeze packages time reproduce document; eliminate potential conflicts packages.Example: first block copies packages source files:next block proceeds install packages:use function install.packages(), indicating type='source'.","code":"# copy package sources\nCOPY pkg/extracat /home/rstudio/pkg/extracat\nCOPY pkg/ggthemr /home/rstudio/pkg/ggthemr\nCOPY pkg/statebins /home/rstudio/pkg/statebins# install from package sources\nRUN Rscript -e \"install.packages(c(\\\n  '/home/rstudio/pkg/extracat', \\\n  '/home/rstudio/pkg/ggthemr', \\\n  '/home/rstudio/pkg/statebins' \\\n  ), repos = NULL, type='source')\""},{"path":"install-packages-from-source.html","id":"install-system-packages","chapter":"7 Install packages from source","heading":"7.1 Install system packages","text":"Linux package QuantLib relatively hard install using apt install. method doesn’t work, install source.Example: script download QuantLib Linux package source, unpack , change source folder, check configuration, install make.","code":"WORKDIR /home/shiny\nRUN wget https://github.com/lballabio/QuantLib/releases/download/QuantLib-v1.19/QuantLib-1.19.tar.gz && \\\n    tar xzf QuantLib-1.19.tar.gz && \\\n    cd QuantLib-1.19 \n    ./configure && \\\n    make"},{"path":"copy-container-content-to-the-host.html","id":"copy-container-content-to-the-host","chapter":"8 Copy container content to the host","heading":"8 Copy container content to the host","text":"use technique copy folder files container without explicit copy operation, need spin container image.using obscure development feature Docker called BuildKit. allows us copy set files directly building image. image files extracted created stages; one images contain files copy host.","code":""},{"path":"copy-container-content-to-the-host.html","id":"building-the-image-from-a-dockerfile","chapter":"8 Copy container content to the host","heading":"8.1 Building the image from a Dockerfile","text":"example Dockerfile used copy files stage image called artifact folder host call artifacts. names similar mean certian connection target image output folder host.","code":"# Dockerfile rule\nphony: artifact\nartifact:\n    DOCKER_BUILDKIT=1 docker build --target artifact --output type=local,dest=./artifacts ."},{"path":"copy-container-content-to-the-host.html","id":"steps-to-build-the-image-in-stages","chapter":"8 Copy container content to the host","heading":"8.2 Steps to build the image in stages","text":"following Dockerfile see creation stages. need stages place files need copy later host. trick consists copying set files stage image -files already generated- destination image, contain files.key lines script :","code":"FROM scratch as release\nCOPY --from=bookdown /home/rstudio/book/_book_final /public\nFROM scratch as artifact\nCOPY --from=bookdown /home/rstudio/book/_book_final /public\nFROM release"},{"path":"copy-container-content-to-the-host.html","id":"the-dockerfile","chapter":"8 Copy container content to the host","heading":"8.3 The Dockerfile","text":"following Dockerfile script builds intermediate images final image artifact, extract files. prevent copying large amount files images building, finish script release image, contain another copy selected files, nothing .","code":"# BUILD_DATE for R-3.6.3 is 2020-04-24\n# BUILD_DATE for R-3.5.3 is 2019-04-26\n# FROM rocker/rstudio:3.5.3\n\n# -----------------------------------------------------------------------------\nFROM rocker/rstudio:3.6.3 as linux\n# FROM rocker/verse:3.6.3\n\nRUN apt-get -y update \\\n && apt-get -y install  \\\n    libxml2-dev \\\n    libz-dev\n\n# Linux: pre-requisites gor GDAL, rgdal, rgeos and units\n# Linux: pre-requisites for magick\nRUN apt-get install -y \\\n    libudunits2-dev \\\n    libgdal20 \\\n    libgdal-dev \\\n    libgeos-dev \\ \n    libproj-dev \\\n    libmagick++-dev \\\n    cargo                # required by gifski\n\n# -----------------------------------------------------------------------------\nFROM linux as rstats\n# Install R packages\nRUN install2.r --error --repo https://mran.microsoft.com/snapshot/2019-06-12 \\\n    bookdown \\\n    egg \\\n    forcats \\\n    foreign \\\n    gapminder \\\n    ggrepel \\\n    ggridges \\\n    ggthemes \\\n    ggforce \\\n    gridGraphics \\\n    ggplot2movies \\\n    gridExtra \\\n    gtable \\ \n    hexbin \\\n    lubridate \\\n    magick \\\n    maps \\\n    maptools \\\n    nlme \\\n    nycflights13 \\ \n    plot3D \\\n    rgdal \\\n    rgeos \\\n    readr \\\n    sf \\\n    treemapify \\\n    tidyverse \\\n    units\n\n# mvtnorm required by ungeviz\n# rstanarm required by dviz.supp\n# install statebins from source \nRUN install2.r --error  --repo https://mran.microsoft.com/snapshot/2019-06-12 \\  \n  emmeans \\\n  ggmap \\\n  geofacet \\\n  ggspatial \\\n  gganimate \\\n  lwgeom \\\n  mvtnorm \\\n  rworldmap \\\n  transformr\n\nRUN install2.r --error  --repo https://mran.microsoft.com/snapshot/2019-08-12 \\  \n  rstanarm\n\nRUN install2.r --error  --repo https://mran.microsoft.com/snapshot/2019-12-12 \\  \n  dplyr \\\n  lobstr \\\n  lifecycle \\\n  patchwork \\\n  tidybayes \\\n  tidyr  \n\n# RUN install2.r --error  --repo https://mran.microsoft.com/snapshot/2019-12-12 \\  \n#   patchwork \\\n#   tidybayes  \n\n# RUN install2.r --error  --repo https://mran.microsoft.com/snapshot/2019-12-12 \\  \n#   dplyr \\\n#   tidyr\n\n# -----------------------------------------------------------------------------\nFROM rstats as offline\nRUN install2.r --error  --repo https://mran.microsoft.com/snapshot/2019-12-24 \\  \n  gifski\n\nCOPY pkg/colorspace /home/rstudio/pkg/colorspace\nCOPY pkg/strapgod /home/rstudio/pkg/strapgod\nCOPY pkg/ungeviz /home/rstudio/pkg/ungeviz\nCOPY pkg/cowplot /home/rstudio/pkg/cowplot\nCOPY pkg/colorblindr /home/rstudio/pkg/colorblindr\nCOPY pkg/dviz.supp /home/rstudio/pkg/dviz.supp\nCOPY pkg/ggtextures /home/rstudio/pkg/ggtextures\nCOPY pkg/statebins /home/rstudio/pkg/statebins\n\nRUN Rscript -e \"install.packages(c(\\\n  '/home/rstudio/pkg/colorspace', \\\n  '/home/rstudio/pkg/strapgod', \\\n  '/home/rstudio/pkg/ungeviz', \\\n  '/home/rstudio/pkg/cowplot', \\\n  '/home/rstudio/pkg/colorblindr', \\\n  '/home/rstudio/pkg/dviz.supp', \\\n  '/home/rstudio/pkg/ggtextures', \\\n  '/home/rstudio/pkg/statebins' \\\n  ), repos = NULL, type='source')\"\n\n# RUN Rscript -e \"install.packages(c(\\\n# '/home/rstudio/pkg/ungeviz' \\\n# ), repos = NULL, type='source')\"\n\n# -----------------------------------------------------------------------------\nFROM offline as bookdown\nCOPY dataviz-2020 /home/rstudio/book\nRUN chmod a+rwx -R /home/rstudio/book\nWORKDIR /home/rstudio/book\n# VOLUME write-fast         # creates a folder /write-fast\n\n# build book\nRUN Rscript -e \"bookdown::render_book(\\\n  input = 'index.Rmd', \\\n  output_format = 'bookdown::gitbook', \\\n  config_file = '_bookdown_final.yml')\"\n\n# VOLUME wilke2020          # creates a folder /wilke2020\n# the next command copies the container folder to the volume \n# but it cannot be seen in the host; it will show empty\n  # RUN cp -r _book_final /wilke2020/\n\n# -----------------------------------------------------------------------------\n# Copy selected files from image using Docker BuildKit\n# https://stackoverflow.com/a/58752370/5270873\nFROM scratch as release\nCOPY --from=bookdown /home/rstudio/book/_book_final /public\n# -----------------------------------------------------------------------------\nFROM scratch as artifact\nCOPY --from=bookdown /home/rstudio/book/_book_final /public\n# -----------------------------------------------------------------------------\nFROM release\n\n\n# Run from the host terminal\n# DOCKER_BUILDKIT=1 docker build --target artifact --output type=local,dest=./artifacts ."},{"path":"installing-packages-at-specific-dates.html","id":"installing-packages-at-specific-dates","chapter":"9 Installing packages at specific dates","heading":"9 Installing packages at specific dates","text":"example need install three packages different dates reasons reproducibility. Dates cause error changes functions.","code":"# Error: packages ‘systemfonts’, ‘lifecycle’ are not available (for R version 3.6.3)\n# also fails in travis\n# systemfonts will not be available for 3.6.3 until 2019-06-29\nRUN install2.r --error --repo https://mran.microsoft.com/snapshot/2019-06-29 \\\n    systemfonts\n\n# lifecycle will install after 2019-08-02\n# Error: package ‘lifecycle’ is not available (for R version 3.6.3)\nRUN install2.r --error --repo https://mran.microsoft.com/snapshot/2019-08-02 \\\n    lifecycle\n\n# \"farver\" is dependency of \"scales\"\n# older versions of farver crash book building at 02.Rmd\n# Error in farver:decode_color() unused argument\nRUN install2.r --error --repo https://mran.microsoft.com/snapshot/2020-03-12 \\\n    farver    "},{"path":"dockerfile-and-makefile.html","id":"dockerfile-and-makefile","chapter":"10 Dockerfile and Makefile","heading":"10 Dockerfile and Makefile","text":"","code":""},{"path":"dockerfile-and-makefile.html","id":"running-make-from-a-dockerfile","chapter":"10 Dockerfile and Makefile","heading":"10.1 Running make from a Dockerfile","text":"","code":"# make -j 4: allow 4 jobs\nRUN . /etc/environment \\\n    && cd /analysis              `# change to folder` \\\n    && make clean                `# delete all files` \\ \n    && make -j 4                 `# allow 4 jobs`"},{"path":"editing-tips.html","id":"editing-tips","chapter":"11 Editing tips","heading":"11 Editing tips","text":"","code":""},{"path":"editing-tips.html","id":"break-lines-in-a-rscript-long-command","chapter":"11 Editing tips","heading":"11.1 Break lines in a Rscript long command","text":"need break long Rscript command, break lines single backslash \\.spaces slashEnclose command double quotesThis examples extracted book clauswilke.dataviz.2018.","code":"RUN Rscript -e \"bookdown::render_book(\\\n    input = 'index.Rmd', \\\n    output_format = 'bookdown::gitbook', \\\n    config_file = '_bookdown_final.yml')\""},{"path":"references.html","id":"references","chapter":"References","heading":"References","text":"","code":""}]
